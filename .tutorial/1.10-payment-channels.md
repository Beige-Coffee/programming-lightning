# Payment Channels

You can conceptually think of a payment channel as a way to perform batching of your payments over a potentially unlimited length of time. In fact, with a simple payment channel, two parties can make thousands of payments between each other while only ever making two on-chain bitcoin transactions. This reduces both the costs of sending transactions and the cost of storing transaction data, alleviating the three problems we identified earlier. 

## Core concept

So how is this possible? What conceptually is going on when payments are made in a payment channel?

The idea is that the two parties will still construct bitcoin transactions for each payment being made but they agree not to broadcast them to the chain. By not broadcasting each transaction to the chain, the parties do not need to wait for confirmations, do not need to pay miner fees, and do not need to force resource costs onto the entire network.

Like all good computer science textbooks, to help explain this concept, let's introduce our two old friends - Alice and Bob. Note that Alice and Bob each have their own private keys. Alice's private key is represented by a blue key, while Bob's private key is represented by a red key.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/intro_to_htlc/AliceBobKeys.png" alt="AliceBobKeys" width="60%" height="auto">
</p>

## Creating a Simple Payment Channel

To create a payment channel, Alice and Bob start by agreeing to fund a 2-of-2 multisig output with a specific amount. This amount is crucial, as it represents the total channel capacity, meaning Alice and Bob will only be able to transfer up to this amount between themselves.

To fund this channel, Alice and Bob create a **Pay-to-Witness-Script-Hash (P2WSH)** transaction that locks their channel balance into an output controlled by both of them. Specifically, this output requires both Alice and Bob to control one of the keys necessary to spend the funds. 


<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/intro_to_htlc/simple_funding.png" alt="simple_funding.png" width="100%" height="auto">
</p>

### Sending a Payment
Then, to send a payment Alice and Bob can simply create a new transaction that spends from the funding transaction. Each new transaction will have an output for Alice and Bob with their respective channel balances.
<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/intro_to_htlc/simple_payment.png" alt="simple_payment" width="100%" height="auto">
</p>



## Problem: Potential Loss of Funds

How can Alice lose all of her funds in this setup?

<details>
  <summary>Answer</summary>
  <br/>

  If Bob stops responding or refuses to cooperate, then there's no way for Alice to retrieve her funds from this payment channel. This is because, to spend from a 2-of-2 multisig, you need signatures from *both* parties.
</details>


How can we address this problem for Alice?

<details>
  <summary>Answer</summary>
  <br/>

  There are a few different ways to go about this, but the general solution is that we will need to create a way for Alice to recieve a "refund". Can you think of how we can implement this?
</details>