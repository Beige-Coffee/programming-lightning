# Pay-to-Script-Hash (P2SH)

Okay, we've reviewed a **Pay-to-Public-Key-Hash** script. This was relatively simlple and easy to understand. Do we really need to make things more complicated? Of course we do! While P2PKH is sufficient to send bitcoin to someone else, it doesn't allow us to create more complex spending conditions, which are ultimately needed to build additional functionality on Bitcoin. Let's discuss the slightly more complicated, yet flexible, script: **Pay-to-Script-Hash** (**P2SH**).

In a P2SH transaction, bitcoin is "locked" to the hash of a script, as opposed to the hash of public key. The script specifies the conditions that must be met to spend the bitcoin later on. To unlock the bitcoin, the spender must provide:
- The original (unhashed) **Redeem Script** that, when hashed, matches the hash that the bitcoin is locked to.
- Any other data that the redeem script specfies, such as a valid **signature**, **preimage**, etc.)
###
#### What benefits do we obtain by locking to the hash of a script?
<details>
  <summary>Answer</summary>

By locking the bitcoin to the hash of a script, we obtain a few benefits:

1) **Flexibility**: While P2PKH is limited to locking Bitcoin to a single public key, P2SH allows for the bitcoin to be locked to more complex conditions, such as requiring multiple signatures to spend the funds (also known as "Multisig"). As we'll see when we dig into the Lightning Network, a variation of P2SH can be used to lock bitcoin to the hash of a secret message, called a "preimage". Therefore, to spend the funds, you must prove that you know the original secret that produced the hash.
2) **Security**: As we discussed earlier, Bitcoin transactions are publicly viewable on the blockchain. By locking the Bitcoin to a hash of a script, the spending conditions of the script are not viewable until the funds are spent later on.

</details>

## Locking To Multisig
To build our intuition of a P2SH script, let's walk through an example where we'd like to lock our funds such that multiple keys are required to spend those funds. This is a very popular use of P2SH transactions.

For this example, we'll lock our bitcoin such that 2 of 2 signatures must be presented to spend the funds. This is a very popular construct for bitcoin custody today.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/intro_to_htlc/p2sh-2-2-multisig.png" alt="p2sh-2-2-multisig" width="70%" height="auto">
</p>

```
 2 <pubkey1> <pubkey2> 2 OP_CHECKMULTISIG 
```
Let's build a function that takes in two Bitcoin public keys and returns a Script. In this case, this script will be our **Redeem Script**, and it will only be presented when we unlock these bitcoin in the future. However, since we are locking these bitcoin to the hash of this script, we need to create it now.

### ⚡️ Write Function To Generate Pay-To-Script-Hash Redeem Script

Can you write the implementation for a function that takes in two Bitcoin PublicKeys and generates a 2-of-2 multisig redeem script? 
```rust
fn two_of_two_multisig_redeem_script(pubkey1: &PublicKey, pubkey2: &PublicKey) -> Script {}
```

### ⚡️ Write Function To Generate Pay-To-Script-Hash Output Script

Great, now that we've generated the redeem script, we need to hash it and use the hash to create our output script. Remember, our Pay-to-Script-Hash **script** has the following form: 

```
OP_HASH160 <redeem script hash> OP_EQUAL
```

Can you write the implementation for a function that takes the hash of a redeem script and generates a P2SH output script? 
```rust
fn p2sh(redeem_script: &Script) -> Script {}
```

